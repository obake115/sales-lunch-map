rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /maps/{mapId} {
      // Read: authenticated users (join-by-code query requires this)
      allow read: if request.auth != null;

      // Create: must set yourself as owner and member
      allow create: if request.auth != null
        && request.resource.data.ownerId == request.auth.uid
        && request.auth.uid in request.resource.data.memberIds;

      // Update:
      //   - Owner can update any field (readOnly, name, etc.)
      //   - Members can only modify memberIds (leave)
      //   - Non-members can only add themselves to memberIds (join)
      allow update: if request.auth != null && (
        resource.data.ownerId == request.auth.uid ||
        (request.auth.uid in resource.data.memberIds
          && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['memberIds'])) ||
        (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['memberIds'])
          && request.auth.uid in request.resource.data.memberIds)
      );

      // Delete: only owner
      allow delete: if request.auth != null
        && resource.data.ownerId == request.auth.uid;

      match /stores/{storeId} {
        // Read: only members of the parent map
        allow read: if request.auth != null
          && request.auth.uid in get(/databases/$(database)/documents/maps/$(mapId)).data.memberIds;

        // Create/Update: only members
        allow create, update: if request.auth != null
          && request.auth.uid in get(/databases/$(database)/documents/maps/$(mapId)).data.memberIds;

        // Delete: store creator or map owner
        allow delete: if request.auth != null
          && (resource.data.createdBy == request.auth.uid
              || get(/databases/$(database)/documents/maps/$(mapId)).data.ownerId == request.auth.uid);

        match /comments/{commentId} {
          allow read: if request.auth != null
            && request.auth.uid in get(/databases/$(database)/documents/maps/$(mapId)).data.memberIds;

          allow create: if request.auth != null
            && request.auth.uid in get(/databases/$(database)/documents/maps/$(mapId)).data.memberIds;

          // Delete: comment author or map owner
          allow delete: if request.auth != null
            && (resource.data.authorId == request.auth.uid
                || get(/databases/$(database)/documents/maps/$(mapId)).data.ownerId == request.auth.uid);
        }
      }
    }

    match /users/{userId}/{document=**} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
  }
}
